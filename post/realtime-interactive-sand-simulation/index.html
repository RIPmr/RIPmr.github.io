<html>
<head>
	<!--meta charset="utf-8" /-->
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!--meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive"-->
<title>[Research] 实时可交互沙土模拟方法 - 物理部分 | HU ANIME</title>
<link rel="shortcut icon" href="https://huanime.com.cn//favicon.ico?v=1674216748208">
<link rel="stylesheet" href="https://huanime.com.cn//media/scripts/lib/lightbox.css" type='text/css' media='all'>
<link href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" rel="stylesheet">
<link rel="stylesheet" href="https://huanime.com.cn//styles/main.css" type='text/css' media='all'>
<link rel="stylesheet" href="https://huanime.com.cn//media/scripts/lib/atom-one-light.min.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<!--link rel="stylesheet" href="https://huanime.com.cn//media/scripts/lib/katex.min.css" type='text/css' media='all'-->

<script src="https://huanime.com.cn//media/scripts/lib/highlight.min.js"></script>
<script src="https://huanime.com.cn//media/scripts/lib/moment.min.js"></script>

<!-- Google Analytics-->
<!---->

<!--Baidu Analytics-->
<script>
  var _hmt = _hmt || [];
  (function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?264d1f69b0edf52af180e8994eaf44bc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script>

<!--Block Debug Tools-->
<script>
  var debugMode = false;
  function disableInfo() {
    document.onkeydown = function() {
      var e = window.event || arguments[0];
      // block F12
      if (e.keyCode == 123) {
        return false;
      // block Ctrl+Shift+I
      } else if ((e.ctrlKey) && (e.shiftKey) && (e.keyCode == 73)) {
        return false;
      // block Shift+F10
      } else if ((e.shiftKey) && (e.keyCode == 121)) {
        return false;
      }
      // block Ctrl+S
      if ((e.ctrlKey) && (e.keyCode == 83)) {
          return false;
      }
    };
    // block right click
    document.oncontextmenu = function() {
      return false;
    }
    document.oncontextmenu=new Function("event.returnValue=false");  
    document.onselectstart=new Function("event.returnValue=false");  
  }
  if (!debugMode) disableInfo();
</script>

</head>
<body class="home blog ct-body standard">
	<div id="overflow-container" class="overflow-container">
		<a class="skip-content" href="#main">Skip to content</a>
		<header id="site-header" class="site-header" role="banner">
    <div class='top-navigation top-navigation-important'>
        <div class='container'>
            <div id="menu-secondary" class="menu-container menu-secondary" role="navigation">
                <button id="toggle-secondary-navigation" class="toggle-secondary-navigation"><i class="fa fa-plus"></i></button>
                <div class="menu">
                    <ul id="menu-secondary-items" class="menu-secondary-items">
                        
                        
                            
                        <li id="menu-item" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item">
                            <a href="https://huanime.com.cn/tag/itfB5m7XS/">Essay</a>
                        </li>
                            
                        
                            
                        <li id="menu-item" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item">
                            <a href="https://huanime.com.cn/tag/qi5SVakfq/">Tools</a>
                        </li>
                            
                        
                            
                        <li id="menu-item" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item">
                            <a href="https://huanime.com.cn/tag/R8pKVfB50/">Static</a>
                        </li>
                            
                        
                            
                        <li id="menu-item" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item">
                            <a href="https://huanime.com.cn/tag/WSyUFaaTQ/">Anime</a>
                        </li>
                            
                        
                    </ul>
                </div>
            </div>
            <ul class="social-media-icons">
              
                    
                        <li>
                            <a href="https://github.com/RIPmr" data-animate-hover="pulse" class="github" target="_blank">
                              <i class="fab fa-github" title="github"></i>
                                <span class="screen-reader-text">github</span>
                            </a>
                        </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        <li>
                            <a href="https://space.bilibili.com/7868260" data-animate-hover="pulse" class="film" target="_blank">
                              <i class="fas fa-film" title="film"></i>
                                <span class="screen-reader-text">film</span>
                            </a>
                        </li>
                    
                
                    
                        <li>
                            <a href="https://www.artstation.com/huanime" data-animate-hover="pulse" class="image" target="_blank">
                              <i class="fas fa-image" title="image"></i>
                                <span class="screen-reader-text">image</span>
                            </a>
                        </li>
                    
                
                    
                        <li>
                            <a href="https://www.youtube.com/channel/UCkvCi2G2Ay_AnC3NYthteag" data-animate-hover="pulse" class="youtube" target="_blank">
                              <i class="fab fa-youtube" title="youtube"></i>
                                <span class="screen-reader-text">youtube</span>
                            </a>
                        </li>
                    
                
                    
                        <li>
                            <a href="https://assetstore.unity.com/publishers/34649" data-animate-hover="pulse" class="plug" target="_blank">
                              <i class="fas fa-plug" title="plug"></i>
                                <span class="screen-reader-text">plug</span>
                            </a>
                        </li>
                    
                
            </ul>
        </div>
    </div>

    <div class="container">
        <div id="title-info" class="title-info">
            <div id='site-title' class='site-title'>
                <a href="https://huanime.com.cn/">  HU ANIME </a>
            </div>
        </div>
        <button id="toggle-navigation" class="toggle-navigation">
            <i class="fa fa-bars"></i>
        </button>
        <div id="menu-primary-tracks" class="menu-primary-tracks"></div>
        <div id="menu-primary" class="menu-container menu-primary" role="navigation">
            <p class="site-description">会画画的程序猿</p>
            <div class="menu">
                <ul id="menu-primary-items" class="menu-primary-items">
                     
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <!--% if (menu.name == 'GALLERY') {
                                  <a href="/">LINKS</a-->
                                <!--%} else {%-->
                                  <a href="/">HOME</a>
                                <!--%}%-->
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <!--% if (menu.name == 'GALLERY') {
                                  <a href="/archives">LINKS</a-->
                                <!--%} else {%-->
                                  <a href="/archives">TIMELINE</a>
                                <!--%}%-->
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <!--% if (menu.name == 'GALLERY') {
                                  <a href="/post/gallery">LINKS</a-->
                                <!--%} else {%-->
                                  <a href="/post/gallery">GALLERY</a>
                                <!--%}%-->
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <a href="https://huanime.com.cn/document/" target="_blank">DOCUMENT</a>
                            </li>
                        
                    
                        
                            <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page current-menu-item current_page_item'>
                                <!--% if (menu.name == 'GALLERY') {
                                  <a href="/post/about">LINKS</a-->
                                <!--%} else {%-->
                                  <a href="/post/about">ABOUT</a>
                                <!--%}%-->
                            </li>
                        
                    
                </ul>
            </div>
        </div>
    </div>


</header>


		<div id="main" class="main" role="main">
			<div id="loop-container" class="loop-container">
				<div class="post type-post status-publish format-standard has-post-thumbnail hentry category-design tag-design tag-standard-2 tag-tagalicious tag-travel entry full-without-featured odd excerpt-1">
					
					<div class='featured-image lazy lazy-bg-image' data-background="https://huanime.com.cn//post-images/realtime-interactive-sand-simulation.png">
					</div>
					

					<div class="entry-meta">
						<span class="date">· 2022-06-25 ·</span> <span> / </span>
						<span class="author">
							<a href="https://huanime.com.cn/" title="" rel="author"> SEE THE WORLD</a></a>
						</span>
						
						<span class="category">
							<span> / </span>
							<a href="https://huanime.com.cn/tag/itfB5m7XS/">Essay</a>
						</span>
						
					</div>
					<div class='entry-header'>
						<h1 class='entry-title'>[Research] 实时可交互沙土模拟方法 - 物理部分</h1>
					</div>
					
					<div class="entry-container">
					
						<div id="entry-content" class="entry-content">
							<article>
								<pre><code>本篇介绍一种移动端实时交互式沙土模拟方法
</code></pre>
<!-- more -->
<h2 id="real-time-interactive-sand-simulation-in-mobile-platform">Real-time Interactive Sand Simulation in Mobile Platform</h2>
<hr>
<h3 id="背景background">背景/Background</h3>
<p>移动端抽卡玩法已经屡见不鲜，表现形式多为点击、播片，玩家在一次次重复的交互过程中多多少少会产生疲倦感，于是我们决定在玩家交互上下点功夫，带来一些新鲜感。玩法设计上，我们希望是移动端二维俯视角，玩家通过交互刷开覆盖的沙土，发现新的收集品，让玩家在交互过程中体验小心翼翼的紧张感与仪式感，增加开奖时的快乐。</p>
<figure data-type="image" tabindex="1"><img src="https://huanime.com.cn//post-images/1656212137313.png" alt="" loading="lazy"></figure>
<h3 id="技术挑战challenge">技术挑战/Challenge</h3>
<p>首先明确一下我们的效果目标：二维俯视角下的可交互沙土模拟，沙子渲染要有真实感，物理模拟要有体积感。玩家刷开沙子的过程中，沙子的运动要符合真实物理规律，能够被推开，也能够堆叠。当然最主要的是，在移动端，速度要快！</p>
<p>确定技术方案之前，先来看看现实世界里的沙子是怎么组成的。<br>
沙子的成分因产地而异，但其主要还是由矿物和微小的岩石碎片组成。岩石碎片是岩石经过侵蚀和风化而成，颗粒微小，这使得沙子的物理特性有点像流体，但又不能完全套用流体力学的计算方式来模拟其运动过程。</p>
<figure data-type="image" tabindex="2"><img src="https://huanime.com.cn//post-images/1656212209091.png" alt="" loading="lazy"></figure>
<center>沙子的微观形态</center>
<br>
<p>我们先来看看市面上现有的游戏，下图是在沙子模拟效果上比较有代表性的两款作品，但它们明显在模拟规模上偏大，而且在体验上更注重于渲染效果，而非玩家交互，所以无法满足我们的需求。</p>
<figure data-type="image" tabindex="3"><img src="https://huanime.com.cn//post-images/1656212239158.png" alt="" loading="lazy"></figure>
<center>《风之旅人》和《刺客信条》中的沙子模拟</center>
<br>
<p>这两种模拟方法对于现在的新需求来说，都是不适用的，主要原因有以下两点：<br>
1、上面两款游戏的方法适用于沙漠场景中的大规模流沙模拟，是对沙子运动的一种宏观描述，而我们仅需要一小堆沙子；<br>
2、我们希望沙子是能够在有限的交互次数内被刷干净的，而不是永远“流”不完的。</p>
<p>要实现以上这些目标，就必须要有一个相对更加“物理”的模拟方法。图形学上实现真实沙子物理模拟的方法有很多，比如下图是基于物质点法（Material Point Method，MPM）使用Taichi实现的沙子物理模拟：</p>
<center><img src="../../post-images/1656211794583.gif" /></center>
<center>Sand simulation using MPM</center>
<br>
<p>MPM是一种将欧拉法（Eulerian）和拉格朗日法（Lagrangian）结合起来的计算方法，既避免了欧拉法要求解对流项的难题，又解决了拉格朗日法在处理大变形时的网格畸变和负体积问题，主要用于求解冲击、爆炸等高速、大变形问题，尤其是在沙子的动力学解算中非常常用。</p>
<figure data-type="image" tabindex="4"><img src="https://huanime.com.cn//post-images/1656212267111.png" alt="" loading="lazy"></figure>
<center>Iteration process of MPM</center>
<br>
<p>MPM中，沙粒的各种信息被保存在一个个离散的物质点上，然后：<br>
1、将物质点上的信息通过形函数 (Shape Function)映射到背景网格的节点上（Point to Grid，P2G）；<br>
2、通过传统的有限元法（Finite Element Method，FEM），计算单元刚度矩阵、荷载列阵，加入边界条件，求解节点位移、速度等信息；<br>
3、求解完后再通过Shape Function将单元节点上求解出来的信息映射回物质点上（更新物质点的位置、速度等；G2P，Grid to Point）；<br>
4、删除背景网格，返回第1步循环迭代。</p>
<p>MPM作为欧拉法和拉格朗日法之间的媒介，巧妙地在综合两种方法优点的同时又避免了两种方法自身的缺点，能够很好地模拟沙子的流动、扩散、堆叠现象，但它有个致命的问题，就是在移动端——会遇到性能瓶颈。<br>
这时我们会很自然地想到：既然是固定视角，直接做2D MPM效率会不会好呢？现实比较残酷，即使是2D MPM，在移动端单独跑沙子交互都依然帧率堪忧，就别提场景里还要加其他东西了。</p>
<figure data-type="image" tabindex="5"><img src="https://huanime.com.cn//post-images/1656212283147.png" alt="" loading="lazy"></figure>
<center>将MPM直接降维，在中端安卓机型上的性能表现</center>
<br>
<p>再看看shadertoy和youtube上大佬们基于其他解决方案的2D沙子模拟案例，都无一例外是正视图，没有俯视图的案例。而且模拟中直接丢弃了深度信息，沙子没有体积感，物理效果和渲染效果都不够写实。</p>
<figure data-type="image" tabindex="6"><img src="https://huanime.com.cn//post-images/1656212294959.png" alt="" loading="lazy"></figure>
<center>JSConf EU 2019上展示的web端沙子模拟案例</center>
<br>
<p>于是至此我们可以得出结论：现有方案里没有能够满足我们需求的，我们需要一个切实可行的新方案，且主要挑战在于要在满足效果需求的前提下做到在移动端落地。但究竟能不能找到这样一种方法以及能不能顺利落地，我们心里也没底，所以计划是先预研一版看看能否满足我们的效果目标，如果不行，就用简陋一些的“擦玻璃”方案作为保底。</p>
<center><img src="../../post-images/1656212318591.gif" /></center>
<center>类似《遇见逆水寒》锦屏绘春的“擦玻璃”式交互，是我们的保底方案</center>
<br>
<h3 id="模拟部分simulation-part">模拟部分/Simulation Part</h3>
<p>Ubisoft曾在SIGGRAPH 2020上发过一篇Paper：</p>
<figure data-type="image" tabindex="7"><img src="https://huanime.com.cn//post-images/1656212427503.png" alt="" loading="lazy"></figure>
<p>这篇Paper通过离线预计算的可分离泊松滤波器（Separable Poisson Filter）将基于欧拉法的流体模拟降维投影到纹理空间，在模拟质量几乎不变的情况下，实现了大幅性能提升：</p>
<figure data-type="image" tabindex="8"><img src="https://huanime.com.cn//post-images/1656212460959.png" alt="" loading="lazy"></figure>
<p>受其启发，沙子的物理模拟实际上也可以做降维与并行化的优化！由于是俯视角模拟，摄影机是不动的，所以首先我们可以把三维世界空间下的沙粒压缩到一张RGBA纹理上，x和z轴对应纹理空间u和v轴，y轴则压缩到纹理深度，这样就不会丢失沙堆的厚度信息。而且，当我们使用分辨率足够高的纹理进行采样的时候，实际上可以近似地把一个像素点看作一粒沙子：</p>
<figure data-type="image" tabindex="9"><img src="https://huanime.com.cn//post-images/1656212495417.png" alt="" loading="lazy"></figure>
<p>于是我们就不再需要做MPM中P2G和G2P的过程，直接基于像素点模拟即可。<br>
但需要注意的是为了模拟沙子的堆叠，让沙堆在交互过程中更有体积感，我们需要额外维护一个深度通道。由于降维后我们的网格是二维的，因此实际上这就像一个格子里面摞了一叠“小球”，而不是像MPM一样是一个三维网格，每一个网格里平铺多个小球！</p>
<figure data-type="image" tabindex="10"><img src="https://huanime.com.cn//post-images/1656212505203.png" alt="" loading="lazy"></figure>
<p>这个模拟方法我们就称之为DRSS（Dimension Reduction Sand Simulation），整个模拟流程就像这样：</p>
<center><img src="../../post-images/1656212518235.png" /></center>
<center>Iteration process of DRSS sand simulation</center>
<br>
<h4 id="1-preparing-thickness-buffer">1 - Preparing Thickness Buffer</h4>
<p>首先需要准备一个Thickness Buffer，就像这样：</p>
<center><img src="../../post-images/1656212909888.png" width="350" /></center>
<p>我们之前提到过，DRSS的模拟是带有深度信息的，Thickness Buffer就用于模拟沙堆的厚度（深度）。Thickness Buffer并不是程序化生成的，而是手动绘制的，实际模拟中，我们使用纹理的A通道来作为深度通道。用A通道作为Thickness Buffer的好处是，模拟完成之后，在着色阶段，我们可以直接将深度通道作为沙堆的Alpha值来进行渲染，无需进行其他的转换。<br>
而Thickness Buffer之所以要手动绘制，是为了方便artist在使用这套模拟系统的时候，能够方便地指定想要的沙堆的形状和厚度，Thickness Buffer可以简单地基于PS的干介质笔刷绘制得到。</p>
<h4 id="2-rendering-velocity-buffer">2 - Rendering Velocity Buffer</h4>
<p>然后需要准备一个Velocity Buffer，像这样：</p>
<figure data-type="image" tabindex="11"><img src="https://huanime.com.cn//post-images/1656212926996.gif" alt="" loading="lazy"></figure>
<p>Velocity Buffer的作用是描述每一个像素点位置沙子的运动方向，由于俯视角下不需要考虑重力，沙子在无交互情况下是静态的，所以实际上速度场只需要包含玩家交互部分的速度向量就可以了。<br>
速度向量可以是世界空间下的也可以是转到屏幕空间下的，但注意如果用世界空间速度，输出时不能对速度向量做clamp。</p>
<h4 id="3-drss-solver">3 - DRSS Solver</h4>
<h5 id="3-1-流动分量flow-component">3 - 1 - 流动分量（Flow Component）</h5>
<p>对沙子“流动”分量的描述，DRSS中使用半拉格朗日法（Semi-Lagrangian）实现：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>p</mi><mo mathvariant="normal">′</mo></msup><mo>=</mo><mi>p</mi><mo>−</mo><mi>d</mi><mi>t</mi><mo>∗</mo><mi>v</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">p&#x27; = p - dt*vp
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.996332em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">p</span></span></span></span></span></p>
<p>即对于每个位置<em>p</em>，根据位置<em>p</em>的速度<em>v<sub>p</sub></em>，反向寻找到位置<em>p’</em>，使用位置<em>p’</em> 的场的值来作为位置<em>p</em>的新场值。然后不断迭代，以此来描述沙子的运动：</p>
<center><img src="../../post-images/1656213134726.png" width="300" /></center>
<p>但由于我们要并行化地解算沙子的运动，所以不能直接使用上式求解，而是要将其改写成一个类似联合双边滤波（joint bilateral filter）的3x3卷积核形式来使用：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>F</mi><mrow><mi>K</mi><mi>e</mi><mi>r</mi><mi>n</mi><mi>e</mi><mi>l</mi></mrow></msub><mo>=</mo><mi>V</mi><mo>⋅</mo><mrow><mo fence="true">[</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">{F_{Kernel}} = V \cdot \left[ {\begin{array}{ccccccccccccccc}1&amp;1&amp;1\\1&amp;0&amp;1\\1&amp;1&amp;1\end{array}} \right]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">K</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:3.60004em;vertical-align:-1.55002em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-4.05002em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-4.05002em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>其中<em>V</em>为速度场。于是可得：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>P</mi><mo mathvariant="normal">′</mo></msup><mo>=</mo><mi>P</mi><mo>−</mo><mi>d</mi><mi>t</mi><mo>∗</mo><msub><mi>F</mi><mrow><mi>K</mi><mi>e</mi><mi>r</mi><mi>n</mi><mi>e</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P&#x27; = P - dt*{F_{Kernel}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.801892em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">K</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>其中<em>P’<em>和</em>P</em>为位置矩阵。于是我们就可以得到沙子运动的流动分量，下图为不同速度下的流动分量模拟结果，交互物体从右侧开始运动，红线为停止线。可以看到速度较慢的时候，沙子运动距离短；速度快时，沙子运动距离更长，模拟结果符合物理规律。</p>
<center><img src="../../post-images/1656213238118.png" width="350" /></center>
<br>
<h5 id="3-2-扩散分量spread-component">3 - 2 - 扩散分量（Spread Component）</h5>
<p>由于沙子互相之间会发生碰撞挤压，因此除了单纯的流动之外，随着交互物体的移动，沙子还会在运动过程中发生扩散。<br>
扩散分量我们使用下式描述：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi><mo>=</mo><mi>L</mi><mi>q</mi><mo>⋅</mo><mi mathvariant="normal">D</mi><mo>(</mo><mrow><mi mathvariant="normal">D</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">t</mi></mrow><mo>(</mo><mi>p</mi><mo>−</mo><mi>q</mi><mo separator="true">,</mo><msub><mover accent="true"><mi>v</mi><mo>^</mo></mover><mi>q</mi></msub><mo>)</mo><mo separator="true">,</mo><mi>θ</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">S = Lq \cdot {\rm{D}}({\rm{Dot}}(p - q,{\hat v_q}),\theta )
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">L</span><span class="mord mathdefault" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">D</span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">D</span><span class="mord mathrm">o</span><span class="mord mathrm">t</span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.69444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.22222em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span></p>
<p>其中，<em>p</em>和<em>q</em>分别为当前像素点坐标和邻域像素点坐标；<em>L<sub>q</sub><em>为衰减因子，我们在下一部分堆叠分量中作详细介绍；Dot(<em>a</em>,<em>b</em>)为求向量</em>a</em>和<em>b</em>的点积；<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>v</mi><mo>^</mo></mover><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">{\hat v_q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.69444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.22222em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></span>为规范化后的速度场在位置<em>q</em>处的速度向量；<em>θ</em>为扩散角度，由用户指定。</p>
<p>D(<em>x</em>,<em>θ</em>)为扩散函数，它是一个分段函数：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">D</mi><mo>(</mo><mi>x</mi><mo separator="true">,</mo><mi>θ</mi><mo>)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn><mo separator="true">,</mo><mi>x</mi><mo>&gt;</mo><mi>θ</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn><mo separator="true">,</mo><mi>o</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>r</mi><mi>w</mi><mi>i</mi><mi>s</mi><mi>e</mi></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">{\rm{D}}(x,\theta ) = \left\{ {\begin{array}{ccccccccccccccc}{1,x &gt; \theta }\\{0,otherwise}\end{array}} \right.
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">D</span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.40003em;vertical-align:-0.95003em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">{</span></span><span class="mord"><span class="mord"><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span></span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mord mathdefault">h</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="mord mathdefault">i</span><span class="mord mathdefault">s</span><span class="mord mathdefault">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>扩散分量的模拟结果见下图，<em>θ</em>越大，随着交互物体的运动沙子会在流动的过程中扩散地越远；而当<em>θ</em>越接近0，则沙子只会在直线上流动。</p>
<table style="border: none;">
        <td style="border: none;"><img src="../../post-images/1673783239030.gif" /></td>
        <td style="border: none;"><img src="../../post-images/1673783243436.gif" /></td>
</table>
<center>Spread component, left:θ=0.05, right:θ=0.6</center>
<br>
<h5 id="3-3-堆叠迁移分量drift-component">3 - 3 - 堆叠&amp;迁移分量（Drift Component）</h5>
<p>虽然是降维模拟，但我们希望沙堆能具有体积感，单纯地基于像素点模拟单层沙子是无法体现出体积感的，因此堆叠分量就是基于我们最初设计的存储在A通道中的Thickness Buffer模拟厚度不匀的沙堆的体积感。</p>
<p>我们可以把厚度的模拟看作这样一个过程：每一个像素点上垂直堆叠了多层沙粒，每一次玩家交互，交互物体略过沙堆表面时，我们限制让其只能带动一定层数的沙粒，并且被带动的沙粒能够通过流动和扩散转移到其他像素格里，这样一来，就能够模拟沙堆的体积感了。</p>
<figure data-type="image" tabindex="12"><img src="https://huanime.com.cn//post-images/1673783744185.png" alt="" loading="lazy"></figure>
<p>实际迭代中，我们用下式描述这一过程：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>D</mi><mi>r</mi><mi>i</mi><mi>f</mi><mi>t</mi><mo>=</mo><munder><mo>∑</mo><mrow><mi>q</mi><mo>∈</mo><mi>S</mi></mrow></munder><mrow><mi>L</mi><mi>q</mi><mo>⋅</mo><mi mathvariant="normal">D</mi><mo>(</mo><mi>A</mi><mo separator="true">,</mo><mi>θ</mi><mo>)</mo><mo>⋅</mo><msub><mi>F</mi><mrow><mi>K</mi><mi>e</mi><mi>r</mi><mi>n</mi><mi>e</mi><mi>l</mi></mrow></msub><mo>⋅</mo><mi>T</mi><mi>q</mi></mrow></mrow><annotation encoding="application/x-tex">Drift = \sum\limits_{q \in S} {Lq \cdot {\rm{D}}(A,\theta ) \cdot {F_{Kernel}} \cdot Tq} 
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.480449em;vertical-align:-1.430444em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8556639999999998em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">q</span><span class="mrel mtight">∈</span><span class="mord mathdefault mtight" style="margin-right:0.05764em;">S</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.430444em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="mord mathdefault" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">D</span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">K</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.03588em;">q</span></span></span></span></span></span></p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi><mo>=</mo><mrow><mi mathvariant="normal">D</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">t</mi></mrow><mo>(</mo><mi>p</mi><mo>−</mo><mi>q</mi><mo separator="true">,</mo><msub><mover accent="true"><mi>v</mi><mo>^</mo></mover><mi>q</mi></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">A = {\rm{Dot}}(p - q,{\hat v_q})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">D</span><span class="mord mathrm">o</span><span class="mord mathrm">t</span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.69444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.22222em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>其中<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>T</mi><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">{T_q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></span>为像素<em>p</em>邻域<em>S</em>内的任意点<em>q</em>处的厚度值；衰减因子<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">{L_q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></span>由两个分量组成：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi><mi>q</mi><mo>=</mo><msub><mi mathvariant="normal">G</mi><mrow><mi>σ</mi><mi>S</mi></mrow></msub><mo>(</mo><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi>p</mi><mo>−</mo><mi>q</mi><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mo>)</mo><mo>⋅</mo><mi mathvariant="normal">L</mi><mo>(</mo><msub><mi>T</mi><mi>p</mi></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">Lq = {{\rm{G}}_{\sigma S}}(||p - q||) \cdot {\rm{L}}({T_p})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">L</span><span class="mord mathdefault" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">G</span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">σ</span><span class="mord mathdefault mtight" style="margin-right:0.05764em;">S</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">∣</span><span class="mord">∣</span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">q</span><span class="mord">∣</span><span class="mord">∣</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">L</span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>第一个分量G为高斯核，用于限制堆叠分量在向周围像素转移过程中的移动距离；第二个分量为一个分段函数L(<em>x</em>)：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">L</mi><mo>(</mo><mi>x</mi><mo>)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi><mo separator="true">,</mo><mi>x</mi><mo>≥</mo><mn>0.5</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1.0</mn><mo separator="true">,</mo><mi>o</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>r</mi><mi>w</mi><mi>i</mi><mi>s</mi><mi>e</mi></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">{\rm{L}}(x) = \left\{ {\begin{array}{ccccccccccccccc}{loss,x \ge 0.5}\\{1.0,otherwise}\end{array}} \right.
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">L</span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.40003em;vertical-align:-0.95003em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">{</span></span><span class="mord"><span class="mord"><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span></span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mord mathdefault">h</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="mord mathdefault">i</span><span class="mord mathdefault">s</span><span class="mord mathdefault">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><em>loss</em>是损失常量，由用户指定。<em>loss</em>为1.0时，沙子在转移过程中不会产生任何厚度损失，完全物理正确，但实际体验会发现这种情况下玩家需要反复擦拭一个位置才能把这个位置的沙子完全清理干净，看到下面覆盖的东西，玩起来很累，玩家体验不好。因此增加<em>loss</em>常量就能够让沙子在转移的过程中不断产生微小的厚度损失，让沙子更容易被擦干净：</p>
<figure data-type="image" tabindex="13"><img src="https://huanime.com.cn//post-images/1673784857921.gif" alt="" loading="lazy"></figure>
<h4 id="4-bring-all-the-components-together">4 - Bring all the components together!</h4>

							</article>
						</div>


						
							<div class='entry-meta-bottom'>
								<div class="entry-categories">
									<p>
										<span>Categories</span>
										
										
										
										<a href="https://huanime.com.cn/tag/itfB5m7XS/" title="View all posts in Essay">Essay</a>
										
										
										
										<a href="https://huanime.com.cn/tag/qi5SVakfq/" title="View all posts in Tools">Tools</a>
										
										
										
										<a href="https://huanime.com.cn/tag/R8pKVfB50/" title="View all posts in Static">Static</a>
										
										
										
										<a href="https://huanime.com.cn/tag/WSyUFaaTQ/" title="View all posts in Anime">Anime</a>
										
										
									</p>
								</div>
								<div class="entry-tags">
									<p>
										<span>Tags</span>
										
										<span class="category">
											<a href="https://huanime.com.cn/tag/itfB5m7XS/">Essay</a>
										</span>
										
									</p>
									</br>
									<span>Home</span>
									<span><a href="https://ripmr.github.io">Back to Home</a></span>
								</div>
							</div>
							<div class="author-meta">
								<span>
									<img alt='' src="https://huanime.com.cn//images/avatar.png?v=1674216748208" class='avatar avatar-72 photo' height='72' width='72'>
									<!--span>WRITTEN BY: </span-->
								</span>
								<span>
								<p>
									
										<a href="https://huanime.com.cn/post/realtime-sand-rendering/">上一篇->[Research] 实时可交互沙土模拟方法 - 渲染部分</a>
									
								</p>
								<br/>
								<p>
									
										<a href="https://huanime.com.cn/post/statictake-a-shot/">下一篇->[Static]Take-A-Shot</a>
									
									
								</p>
								</span>
								
								<!--span>
									<p></p>
									
									
									<a class="github" target="_blank"
									   href="https://github.com/RIPmr">
										<i class="fab fa-github" title="github"></i>
									</a>
									
									
									
									
									
									
									
									
									
									
									
									
									
									
									
									
								</span-->

							</div>
						
					</div>
				</div>
				<section id="comments" class="comments">
					
					
					<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<div id="gitalk-container"></div>

<script>

  var gitalk = new Gitalk({
    clientID: '99293e39ad48006e77cb',
    clientSecret: '48d99f5e46f34d52cfdc2051dd531dd9e437936a',
    repo: 'RIPmr.github.io',
    owner: 'RIPmr',
    admin: ['RIPmr'],
    id: location.pathname,      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')

</script>

					

					
					
				</section>
			</div>
		</div>
		<footer id="site-footer" class="site-footer" role="contentinfo">
    <h1>
        <a href="https://huanime.com.cn/"> HU ANIME </a>
    </h1>
    <p class="site-description">会画画的程序猿</p>
    <div id="menu-footer" class="menu-container menu-footer" role="navigation">
        <div class="menu">
            <ul id="menu-footer-items" class="menu-footer-items">
            </ul>
        </div>
    </div>
    <ul class="social-media-icons">
        
            
                <li>
                    <a href="https://github.com/RIPmr" data-animate-hover="pulse" class="github" target="_blank">
                        <i class="fab fa-github" title="github"></i>
                        <span class="screen-reader-text">github</span>
                    </a>
                </li>
            
        
            
        
            
        
            
        
            
        
            
        
            
                <li>
                    <a href="https://space.bilibili.com/7868260" data-animate-hover="pulse" class="film" target="_blank">
                        <i class="fas fa-film" title="film"></i>
                        <span class="screen-reader-text">film</span>
                    </a>
                </li>
            
        
            
                <li>
                    <a href="https://www.artstation.com/huanime" data-animate-hover="pulse" class="image" target="_blank">
                        <i class="fas fa-image" title="image"></i>
                        <span class="screen-reader-text">image</span>
                    </a>
                </li>
            
        
            
                <li>
                    <a href="https://www.youtube.com/channel/UCkvCi2G2Ay_AnC3NYthteag" data-animate-hover="pulse" class="youtube" target="_blank">
                        <i class="fab fa-youtube" title="youtube"></i>
                        <span class="screen-reader-text">youtube</span>
                    </a>
                </li>
            
        
            
                <li>
                    <a href="https://assetstore.unity.com/publishers/34649" data-animate-hover="pulse" class="plug" target="_blank">
                        <i class="fas fa-plug" title="plug"></i>
                        <span class="screen-reader-text">plug</span>
                    </a>
                </li>
            
        
    </ul>
    <div class="design-credit">
        <p>SEE THE WORLD</a></p>
    </div>
</footer>

<!--script>hljs.highlightAll();</script-->
<script>
  var codeBlocks = document.getElementsByName("codeblock");
  if (codeBlocks.length) {
    for (var i = 0; i < codeBlocks.length; i++) {
      hljs.highlightBlock(codeBlocks[i]);
    }
  }
</script>

<!--script src="https://huanime.com.cn//media/scripts/lib/lightbox-plus-jquery.min.js"></script>-->
<script src="https://huanime.com.cn//media/scripts/lib/jquery.min.js"></script>
<script src="https://huanime.com.cn//media/scripts/lib/jquerymigrate.js"></script>
<script src="https://huanime.com.cn//media/scripts/lib/production.min.js"></script>
<script src="https://huanime.com.cn//media/scripts/lib/lightbox.min.js"></script>
	</div>
</body>
</html>

